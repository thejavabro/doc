validation/
 â”œâ”€â”€ ValidationService.java
 â”œâ”€â”€ ValidationContext.java
 â”œâ”€â”€ ValidationRule.java
 â”œâ”€â”€ rules/
 â”‚    â”œâ”€â”€ GlobalEntityRule.java
 â”‚    â”œâ”€â”€ ActionBasedRule.java
 â”‚    â”œâ”€â”€ EntityRelationshipRule.java
 â”‚    â”œâ”€â”€ IdentityXorRule.java
 â”‚    â””â”€â”€ EntityNameUniquenessRule.java

public class ValidationContext {

    private final UdpPersistenceRequest request;
    private final DataSet dataSet;
    private final Entity entity;
    private final ActionCode actionCode;
    private final MetadataRecordType ruleType;

    public ValidationContext(UdpPersistenceRequest request,
                             DataSet dataSet,
                             Entity entity) {

        this.request = request;
        this.dataSet = dataSet;
        this.entity = entity;

        this.actionCode =
            ActionCode.valueOf(request.getActionCode());

        this.ruleType =
            MetadataRecordType.valueOf(entity.getMetadataRecordType());
    }

    public UdpPersistenceRequest request() { return request; }
    public DataSet dataSet() { return dataSet; }
    public Entity entity() { return entity; }
    public ActionCode action() { return actionCode; }
    public MetadataRecordType ruleType() { return ruleType; }
}

public class ValidationService {

    private final List<ValidationConstraint> entityConstraints;
    private final List<ValidationConstraint> requestConstraints;

    public ValidationService() {
        this.requestConstraints = List.of(
            new EntityNameUniquenessConstraint(),
            new IdentityConstraint()
        );

        this.entityConstraints = List.of(
            new GlobalEntityConstraint(),
            new ActionBasedConstraint(),
            new EntityRelationshipConstraint()
        );
    }

    public void validateUdpPersistenceRequestValues(
            UdpPersistenceRequest request) {

        // ðŸ”¹ request-level constraints
        ValidationContext requestCtx =
            new ValidationContext(request, null, null);

        for (ValidationConstraint c : requestConstraints) {
            c.validate(requestCtx);
        }

        // ðŸ”¹ entity-level constraints
        for (DataSet dataSet : request.getDataSets()) {
            for (Entity entity : dataSet.getEntities()) {

                ValidationContext ctx =
                    new ValidationContext(request, dataSet, entity);

                for (ValidationConstraint c : entityConstraints) {
                    c.validate(ctx);
                }
            }
        }
    }
}

    private void validateGlobalRequestLevel(UdpPersistenceRequest request) {
        if (request.getActionCode() == null) {
            throw new ValidationException("actionCode is mandatory");
        }
    }
}


public interface ValidationRule {
    void validate(ValidationContext ctx);
}

public class GlobalEntityRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();

        require(e.getEntityName(), "entityName");
        require(e.getEntityType(), "entityType");
        require(e.getMetadataRecordType(), "metadataRecordType");
        require(e.getMetadataStatusCd(), "metadataStatusCd");
        require(e.getEntityDescription(), "entityDescription");
    }

    private void require(Object value, String field) {
        if (value == null) {
            throw new ValidationException(field + " is mandatory");
        }
    }
}



public class ActionBasedRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();

        if (ctx.action() == ActionCode.INSERT) {
            mustBeNull(e.getEntityMasterId(), "entityMasterId");
            mustBeNull(e.getRecordId(), "recordId");
        }

        if (ctx.action() == ActionCode.UPDATE) {
            require(e.getEntityMasterId(), "entityMasterId");
            require(e.getRecordId(), "recordId");
        }
    }

    private void require(Object v, String f) {
        if (v == null) {
            throw new ValidationException(f + " is mandatory for UPDATE");
        }
    }

    private void mustBeNull(Object v, String f) {
        if (v != null) {
            throw new ValidationException(f + " must be null for INSERT");
        }
    }
}


public class EntityRelationshipRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();
        if (e.getEntityRelationships() == null) return;

        for (EntityRelationship r : e.getEntityRelationships()) {
            require(r.getMetadataStatusCd(), "relationship.metadataStatusCd");
            require(r.getMetadataRecordType(), "relationship.metadataRecordType");
            require(r.getRelationshipType(), "relationshipType");
            require(r.getEntityType(), "relationship.entityType");
            require(r.getToUuid(), "toUuid");
            require(r.getToEntityMasterId(), "toEntityMasterId");
        }
    }

    private void require(Object v, String f) {
        if (v == null) {
            throw new ValidationException(f + " is mandatory");
        }
    }
}


public class IdentityXorRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        User user = ctx.request().getUser();
        AppInfo app = ctx.request().getAppInfo();

        boolean hasUser =
            user != null && user.getSoeid() != null;

        boolean hasApp =
            app != null && app.getAppId() != null;

        if (hasUser == hasApp) {
            throw new ValidationException(
                "Exactly one of user.soeid or appInfo.appId must be present"
            );
        }
    }
}



public class EntityNameUniquenessConstraint
        implements ValidationConstraint {

    @Override
    public void validate(ValidationContext ctx) {

        UdpPersistenceRequest request = ctx.request();

        Set<String> seenNames = new HashSet<>();

        for (DataSet dataSet : request.getDataSets()) {
            for (Entity entity : dataSet.getEntities()) {

                String entityName = entity.getEntityName();

                if (entityName == null) {
                    // entityName mandatory is validated elsewhere
                    continue;
                }

                if (!seenNames.add(entityName)) {
                    throw new ValidationException(
                        "Duplicate entityName found in request: " + entityName
                    );
                }
            }
        }
    }
}



public class ValidationService {

    private final List<ValidationRule> rules;

    public ValidationService(EntityRepository repository) {

        this.rules = List.of(
            new GlobalEntityRule(),
            new ActionBasedRule(),
            new EntityRelationshipRule(),
            new IdentityXorRule(),
            new EntityNameUniquenessRule(repository)
        );
    }

    public void validateUdpPersistenceRequestValues(
            UdpPersistenceRequest request) {

        ValidationContext ctx = new ValidationContext(request);

        for (ValidationRule rule : rules) {
            rule.validate(ctx);
        }
    }
}


@PostMapping("/udpPersist")
public UdpPersistenceResponse smartPersist(
        @RequestBody UdpPersistenceRequest request) {

    validationService.validateUdpPersistenceRequestValues(request);

    // existing flow continues
}






public class ValidationContext {

    private final UdpPersistenceRequest request;
    private final Entity entity;
    private final ActionCode actionCode;
    private final MetadataRecordType ruleType;

    public ValidationContext(UdpPersistenceRequest request,
                             Entity entity) {

        this.request = request;
        this.entity = entity;

        this.actionCode = resolveActionCode(request.getActionCode());

        this.ruleType =
            entity != null
                ? resolveRuleType(entity.getMetadataRecordType())
                : null;
    }

    private ActionCode resolveActionCode(String value) {
        if (value == null) {
            throw new ValidationException("actionCode is mandatory");
        }
        try {
            return ActionCode.valueOf(value);
        } catch (IllegalArgumentException ex) {
            throw new ValidationException(
                "Invalid actionCode. Allowed values: INSERT, UPDATE"
            );
        }
    }

    private MetadataRecordType resolveRuleType(String value) {
        if (value == null) {
            throw new ValidationException("metadataRecordType is mandatory");
        }
        try {
            return MetadataRecordType.valueOf(value);
        } catch (IllegalArgumentException ex) {
            throw new ValidationException(
                "Invalid metadataRecordType: " + value
            );
        }
    }

    public UdpPersistenceRequest request() { return request; }
    public Entity entity() { return entity; }
    public ActionCode action() { return actionCode; }
    public MetadataRecordType ruleType() { return ruleType; }
}



public class ValidationService {

    private final List<ValidationConstraint> requestConstraints;
    private final List<ValidationConstraint> entityConstraints;

    public ValidationService() {
        this.requestConstraints = List.of(
            new IdentityConstraint(),
            new EntityNameUniquenessConstraint()
        );

        this.entityConstraints = List.of(
            new GlobalEntityConstraint(),
            new ActionBasedConstraint(),
            new EntityRelationshipConstraint()
        );
    }

    public void validateUdpPersistenceRequestValues(
            UdpPersistenceRequest request) {

        // Request-level constraints
        ValidationContext requestCtx =
            new ValidationContext(request, null);

        for (ValidationConstraint c : requestConstraints) {
            c.validate(requestCtx);
        }

        // Entity-level constraints
        for (DataSet ds : request.getDataSets()) {
            for (Entity entity : ds.getEntities()) {

                ValidationContext ctx =
                    new ValidationContext(request, entity);

                for (ValidationConstraint c : entityConstraints) {
                    c.validate(ctx);
                }
            }
        }
    }
}

