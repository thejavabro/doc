validation/
 ├── ValidationService.java
 ├── ValidationContext.java
 ├── ValidationRule.java
 ├── rules/
 │    ├── GlobalEntityRule.java
 │    ├── ActionBasedRule.java
 │    ├── EntityRelationshipRule.java
 │    ├── IdentityXorRule.java
 │    └── EntityNameUniquenessRule.java

public class ValidationContext {

    private final UdpPersistenceRequest request;
    private final ActionCode actionCode;
    private final MetadataRecordType ruleType;
    private final Entity entity;

    public ValidationContext(UdpPersistenceRequest request) {
        this.request = request;

        this.actionCode =
            ActionCode.valueOf(request.getActionCode());

        this.entity =
            request.getDataSets().get(0)
                   .getEntities().get(0);

        this.ruleType =
            MetadataRecordType.valueOf(
                entity.getMetadataRecordType());
    }

    public UdpPersistenceRequest request() { return request; }
    public ActionCode action() { return actionCode; }
    public MetadataRecordType ruleType() { return ruleType; }
    public Entity entity() { return entity; }
}


public interface ValidationRule {
    void validate(ValidationContext ctx);
}

public class GlobalEntityRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();

        require(e.getEntityName(), "entityName");
        require(e.getEntityType(), "entityType");
        require(e.getMetadataRecordType(), "metadataRecordType");
        require(e.getMetadataStatusCd(), "metadataStatusCd");
        require(e.getEntityDescription(), "entityDescription");
    }

    private void require(Object value, String field) {
        if (value == null) {
            throw new ValidationException(field + " is mandatory");
        }
    }
}



public class ActionBasedRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();

        if (ctx.action() == ActionCode.INSERT) {
            mustBeNull(e.getEntityMasterId(), "entityMasterId");
            mustBeNull(e.getRecordId(), "recordId");
        }

        if (ctx.action() == ActionCode.UPDATE) {
            require(e.getEntityMasterId(), "entityMasterId");
            require(e.getRecordId(), "recordId");
        }
    }

    private void require(Object v, String f) {
        if (v == null) {
            throw new ValidationException(f + " is mandatory for UPDATE");
        }
    }

    private void mustBeNull(Object v, String f) {
        if (v != null) {
            throw new ValidationException(f + " must be null for INSERT");
        }
    }
}


public class EntityRelationshipRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        Entity e = ctx.entity();
        if (e.getEntityRelationships() == null) return;

        for (EntityRelationship r : e.getEntityRelationships()) {
            require(r.getMetadataStatusCd(), "relationship.metadataStatusCd");
            require(r.getMetadataRecordType(), "relationship.metadataRecordType");
            require(r.getRelationshipType(), "relationshipType");
            require(r.getEntityType(), "relationship.entityType");
            require(r.getToUuid(), "toUuid");
            require(r.getToEntityMasterId(), "toEntityMasterId");
        }
    }

    private void require(Object v, String f) {
        if (v == null) {
            throw new ValidationException(f + " is mandatory");
        }
    }
}


public class IdentityXorRule implements ValidationRule {

    @Override
    public void validate(ValidationContext ctx) {

        User user = ctx.request().getUser();
        AppInfo app = ctx.request().getAppInfo();

        boolean hasUser =
            user != null && user.getSoeid() != null;

        boolean hasApp =
            app != null && app.getAppId() != null;

        if (hasUser == hasApp) {
            throw new ValidationException(
                "Exactly one of user.soeid or appInfo.appId must be present"
            );
        }
    }
}



public class EntityNameUniquenessRule implements ValidationRule {

    private final EntityRepository repository;

    public EntityNameUniquenessRule(EntityRepository repository) {
        this.repository = repository;
    }

    @Override
    public void validate(ValidationContext ctx) {
        if (repository.existsByEntityName(
                ctx.entity().getEntityName())) {
            throw new ValidationException(
                "Duplicate entityName not allowed");
        }
    }
}




public class ValidationService {

    private final List<ValidationRule> rules;

    public ValidationService(EntityRepository repository) {

        this.rules = List.of(
            new GlobalEntityRule(),
            new ActionBasedRule(),
            new EntityRelationshipRule(),
            new IdentityXorRule(),
            new EntityNameUniquenessRule(repository)
        );
    }

    public void validateUdpPersistenceRequestValues(
            UdpPersistenceRequest request) {

        ValidationContext ctx = new ValidationContext(request);

        for (ValidationRule rule : rules) {
            rule.validate(ctx);
        }
    }
}


@PostMapping("/udpPersist")
public UdpPersistenceResponse smartPersist(
        @RequestBody UdpPersistenceRequest request) {

    validationService.validateUdpPersistenceRequestValues(request);

    // existing flow continues
}
